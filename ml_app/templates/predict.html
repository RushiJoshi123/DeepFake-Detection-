{% extends 'base.html' %}
{% load static %}
{%block content%}
{%if no_faces%}
<div class="container">
  <div class="logo text-center mb-3"><img src="{% static 'images/logo1.png'%}" alt="Logo" ></div>
  <hr />
  <div class="alert alert-danger">
    No faces detected. Cannot process the video.
  </div>
</div>
{%else%}
<div class="container">
  <div class="logo text-center mb-3"><img src="{% static 'images/logo1.png'%}" alt="Logo" ></div>
  <hr />

  <h3>Frames Split</h3>
  <div id="preprocessed_images" class="col-12 mt-4 mb-2">
    {% for each_image in preprocessed_images %}
    <img src="{%static each_image%}" class="preprocess" width=auto height="250" />
    {%endfor%}
  </div>


  <h3>Face Cropped Frames</h3>
  <div id="faces_images" class="col-12 mb-2">
    {% for each_image in faces_cropped_images %}
    <img src="{%static each_image%}" class="faces" width=auto height="150" />
    {%endfor%}
  </div>
     <h3>Heat Maps</h3>
  <div id="heatmap_images" class="col-12 mb-4 ">
    {% for each_heatmap_image in heatmap_images %}
    <img src="{%static each_heatmap_image%}" class="heat-map" width="100" height="150" />
    {%endfor%}

  </div>
<div class="page-center">
  <div class="result text-center">
    <h3>Real time scanning : </h3>
    <video height="320" width="640" id="predict-media" controls>
      <source src="{{MEDIA_URL}}{{original_video}}" type="video/mp4" codecs="avc1.4d002a" />
    </video>
    {%if output == "REAL" %}
    <h4 class="mx-auto">Conclusion: <span style="color:green">{{output}}</span>
      <img src="{% static 'images/thumpup.png'%}" alt="real" height="100px" width=auto>
      {%else%}
      <h4 class="mx-auto">Conclusion: <span style="color:red">{{output}}</span>
        <img src="{% static 'images/thumpdown.png'%}" alt="fake" height="100px" width=auto >
      {%endif%}


  </div>
  <h3>Confidence : {{confidence}}%</h3>
  <div class="mt-2 text-center">
    <small class="text-muted">Mean: {{mean_confidence}}% | Std Dev: {{std_confidence}}%</small>
  </div>
  </div>

  <!-- Confidence Analysis Section -->
  <div class="mt-5">
    <h3 class="text-center mb-4">Confidence Analysis</h3>
    
    <div class="row">
      <!-- Line Graph -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Frame-wise Confidence Trend</h5>
          </div>
          <div class="card-body text-center">
            {% if confidence_line_graph %}
              <img src="{% static 'graph/' %}{{ confidence_line_graph }}" class="img-fluid" alt="Confidence Line Graph" style="max-width: 100%; height: auto;">
            {% endif %}
          </div>
        </div>
      </div>
      
      <!-- Histogram -->
      <div class="col-md-6 mb-4">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Confidence Distribution</h5>
          </div>
          <div class="card-body text-center">
            {% if confidence_histogram %}
              <img src="{% static 'graph/' %}{{ confidence_histogram }}" class="img-fluid" alt="Confidence Histogram" style="max-width: 100%; height: auto;">
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    
    <!-- Summary Statistics -->
    <div class="row mt-3">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5 class="card-title mb-0">Statistical Summary</h5>
          </div>
          <div class="card-body">
            <div class="row text-center">
              <div class="col-md-3">
                <h6>Overall Confidence</h6>
                <span class="badge badge-{% if confidence > 80 %}success{% elif confidence > 60 %}warning{% else %}danger{% endif %} p-2">{{confidence}}%</span>
              </div>
              <div class="col-md-3">
                <h6>Mean Frame Confidence</h6>
                <span class="badge badge-info p-2">{{mean_confidence}}%</span>
              </div>
              <div class="col-md-3">
                <h6>Standard Deviation</h6>
                <span class="badge badge-secondary p-2">{{std_confidence}}%</span>
              </div>
              <div class="col-md-3">
                <h6>Total Frames</h6>
                <span class="badge badge-dark p-2">{{frame_confidences|length}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

{%endif%}
{%endblock%}
{% block js_cripts %}
<script src="{% static 'js/face-api.min.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const video = document.getElementById("predict-media");

    Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri('/static/json'),
      faceapi.nets.tinyFaceDetector.loadFromUri('/static/json')
    ]);

    let detectionInterval;

    video.addEventListener("playing", () => {
      let canvas = document.querySelector("canvas");

      if (!canvas) {
        canvas = faceapi.createCanvasFromMedia(video);
        canvas.style.position = "absolute";
        canvas.style.top = video.offsetTop + "px";
        canvas.style.left = video.offsetLeft + "px";
        document.body.appendChild(canvas);
      }

      const displaySize = { width: video.width, height: video.height - 60 };
      faceapi.matchDimensions(canvas, displaySize);

      detectionInterval = setInterval(async () => {
        const detections = await faceapi.detectAllFaces(video);
        const resizedDetections = faceapi.resizeResults(detections, displaySize);
        const ctx = canvas.getContext("2d");

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.style.top = video.offsetTop + "px";
        canvas.style.left = video.offsetLeft + "px";

        resizedDetections.forEach((result, i) => {
          const output = "{{ output }}";
          const confidence = "{{ confidence }}";

          const drawOptions = {
            label: `${output} ${confidence}%`,
            boxColor: output === 'REAL' ? '#0f0' : '#f00'
          };

          const box = {
            x: result.box.x,
            y: result.box.y,
            width: 100,
            height: 100
          };

          const drawBox = new faceapi.draw.DrawBox(box, drawOptions);
          drawBox.draw(canvas);
        });
      }, 1);
    });

    video.addEventListener("pause", () => {
      clearInterval(detectionInterval);
    });
  });
</script>
{% endblock %}
